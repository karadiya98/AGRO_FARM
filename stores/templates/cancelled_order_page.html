<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Your Order</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body and Font Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Container for the page content */
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px; /* Slightly more rounded */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            max-width: 650px; /* A bit wider */
            width: 100%;
            text-align: center;
            margin-top: 50px;
            border: 1px solid #e0e0e0; /* Subtle border */
        }

        /* Heading Styles */
        h1 {
            color: #d9534f; /* A slightly softer red for warmth */
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em; /* Larger heading */
            margin-bottom: 15px;
            letter-spacing: -0.5px;
        }

        h2 {
            color: #555;
            font-size: 1.6em;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        /* Hero message - more engaging */
        .hero-message {
            font-family: 'Playfair Display', serif; /* A touch of elegance */
            font-size: 1.4em;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: 400;
        }

        .hero-message strong {
            color: #d9534f;
        }

        /* Order Details Section */
        .order-details {
            border: 1px solid #e0e0e0;
            border-radius: 10px; /* Slightly more rounded */
            padding: 25px; /* More padding */
            margin-bottom: 30px;
            background-color: #fcfcfc;
            text-align: left;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Inner shadow */
        }

        .order-details p {
            margin: 12px 0; /* More spacing */
            font-size: 1.15em; /* Slightly larger font */
            color: #444;
        }

        .order-details strong {
            color: #222;
            font-weight: 700;
        }

        .order-details .status-indicator {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-left: 5px;
        }

        .status-indicator.processing { background-color: #ffe0b2; color: #e65100; } /* Orange for processing */
        .status-indicator.pending { background-color: #e3f2fd; color: #1976d2; }    /* Blue for pending */
        .status-indicator.shipped { background-color: #e8f5e9; color: #388e3c; }    /* Green for shipped */
        .status-indicator.cancelled { background-color: #ffcdd2; color: #c62828; }  /* Red for cancelled */


        /* Reason Dropdown */
        .reason-section {
            margin-top: 25px;
            margin-bottom: 30px;
            text-align: left;
            padding: 0 10px; /* Align with general text */
        }

        .reason-section label {
            display: block;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .reason-section select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            color: #555;
            background-color: #fff;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.9H5.4c-7.3%200-11%208.5-6.2%2014.2l140.7%20140.7c3.9%203.9%2010.2%203.9%2014.1%200L293.2%2084.1c4.9-5.7%201.2-14.2-6.1-14.2z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .reason-section select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .reason-section textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            color: #555;
            background-color: #fff;
            resize: vertical;
            min-height: 80px;
            margin-top: 15px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .reason-section textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }


        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .action-buttons button {
            padding: 14px 30px; /* Larger buttons */
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700; /* Bolder text */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            user-select: none;
        }

        .action-buttons .confirm-cancel-btn {
            background-color: #d9534f; /* Red for confirm cancellation */
            color: white;
            box-shadow: 0 4px 10px rgba(217, 83, 79, 0.3);
        }

        .action-buttons .confirm-cancel-btn:hover {
            background-color: #c9302c;
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 18px rgba(217, 83, 79, 0.4);
        }

        .action-buttons .go-back-btn {
            background-color: #6c757d; /* Grey for go back */
            color: white;
            box-shadow: 0 4px 10px rgba(108, 117, 125, 0.2);
        }

        .action-buttons .go-back-btn:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(108, 117, 125, 0.3);
        }

        /* Toast Message Styles */
        .toast-message {
            visibility: hidden;
            min-width: 280px;
            margin-left: -140px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 15px 25px;
            position: fixed;
            z-index: 10001;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out, transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .toast-message.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .toast-message.success { background-color: #28a745; }
        .toast-message.error { background-color: #dc3545; }
        .toast-message.info { background-color: #17a2b8; }

        /* Confirmation Dialog Styles */
        .confirmation-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
        }

        .confirmation-dialog-overlay.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease-in-out;
        }

        .confirmation-dialog {
            background: #ffffff;
            border-radius: 15px;
            padding: 35px; /* More padding */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* More prominent shadow */
            text-align: center;
            max-width: 480px; /* Slightly wider */
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }

        .confirmation-dialog-overlay.show .confirmation-dialog {
            transform: scale(1);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .confirmation-dialog h2 {
            color: #d9534f; /* Matching red */
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem; /* Larger title */
            margin-top: 0;
            margin-bottom: 20px;
        }

        .confirmation-dialog p {
            font-size: 1.15rem; /* Slightly larger text */
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .confirmation-dialog .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .confirmation-dialog .dialog-buttons button {
            padding: 12px 28px; /* Slightly larger buttons */
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            border: none;
        }

        .confirmation-dialog .confirm-btn {
            background-color: #d9534f; /* Red for "Confirm Cancellation" */
            color: white;
            box-shadow: 0 4px 10px rgba(217, 83, 79, 0.3);
        }

        .confirmation-dialog .confirm-btn:hover {
            background-color: #c9302c;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(217, 83, 79, 0.4);
        }

        .confirmation-dialog .cancel-btn {
            background-color: #e9ecef; /* Lighter grey */
            color: #555;
            border: 1px solid #ccc;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .confirmation-dialog .cancel-btn:hover {
            background-color: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* Media Queries for responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin-top: 20px;
            }
            h1 {
                font-size: 2em;
            }
            .hero-message {
                font-size: 1.2em;
            }
            .order-details p, .reason-section label, .reason-section select, .reason-section textarea {
                font-size: 1em;
            }
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>We're Sorry to See You Go!</h1>
        <p class="hero-message">
            Before you confirm, please take a moment to review your order details.
            We'd also appreciate it if you could tell us **why you're cancelling**, so we can improve.
            Remember, this action is **irreversible**.
        </p>

        <div class="order-details">
            <p>Order ID: <strong id="order-id">#ORD-12345</strong></p>
            <p>Product: <strong id="product-name">Organic Apples (5 kg)</strong></p>
            <p>Total Amount: <strong id="total-amount">$25.00</strong></p>
            <p>Order Date: <strong id="order-date">2025-05-27</strong></p>
            <p>Status: <strong id="order-status"><span class="status-indicator processing">Processing</span></strong></p>
        </div>

        <div class="reason-section">
            <label for="cancellation-reason">Why are you cancelling?</label>
            <select id="cancellation-reason" name="cancellation_reason">
                <option value="">-- Select a reason --</option>
                <option value="changed_mind">Changed my mind</option>
                <option value="found_better_price">Found a better price elsewhere</option>
                <option value="delivery_too_long">Delivery time is too long</option>
                <option value="item_no_longer_needed">Item no longer needed</option>
                <option value="ordered_by_mistake">Ordered by mistake</option>
                <option value="poor_product_reviews">Poor product reviews</option>
                <option value="customer_service_issue">Customer service issue</option>
                <option value="other">Other (please specify)</option>
            </select>
            <textarea id="other-reason" placeholder="Please tell us more..." style="display: none;"></textarea>
        </div>

        <div class="action-buttons">
            <button type="button" class="confirm-cancel-btn" id="initiateCancelButton">Confirm Cancellation</button>
            <button type="button" class="go-back-btn" onclick="history.back()">Go Back</button>
        </div>
    </div>

    <div id="toastMessage" class="toast-message"></div>

    <div id="confirmationDialogOverlay" class="confirmation-dialog-overlay">
        <div class="confirmation-dialog">
            <h2 id="confirm-dialog-title">Confirm Order Cancellation</h2>
            <p id="confirm-dialog-message">Are you absolutely sure you want to cancel this order? This action cannot be undone.</p>
            <div class="dialog-buttons">
                <button class="confirm-btn" id="confirmActionFinalButton">Yes, Cancel Order</button>
                <button class="cancel-btn" id="cancelActionFinalButton">No, Keep Order</button>
            </div>
        </div>
    </div>

    <script>
        // --- Helper Functions (Toast and Confirmation Dialog) ---

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById("toastMessage");
            toast.textContent = message;
            toast.className = `toast-message ${type}`;
            toast.classList.add("show");

            setTimeout(() => {
                toast.classList.remove("show");
                toast.addEventListener('transitionend', () => {
                    toast.className = 'toast-message';
                }, { once: true });
            }, duration);
        }

        function showConfirmationDialog(title, message) {
            const overlay = document.getElementById('confirmationDialogOverlay');
            const titleElement = document.getElementById('confirm-dialog-title');
            const messageElement = document.getElementById('confirm-dialog-message');
            const confirmButton = document.getElementById('confirmActionFinalButton');
            const cancelButton = document.getElementById('cancelActionFinalButton');

            titleElement.textContent = title;
            messageElement.textContent = message;

            return new Promise((resolve) => {
                const handleConfirm = () => {
                    overlay.classList.remove('show');
                    confirmButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    overlay.classList.remove('show');
                    confirmButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', handleCancel);

                overlay.classList.add('show');
            });
        }

        // --- Main Page Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            const reasonSelect = document.getElementById('cancellation-reason');
            const otherReasonTextarea = document.getElementById('other-reason');
            const initiateCancelButton = document.getElementById('initiateCancelButton');

            // Toggle "Other" reason textarea visibility
            reasonSelect.addEventListener('change', () => {
                if (reasonSelect.value === 'other') {
                    otherReasonTextarea.style.display = 'block';
                    otherReasonTextarea.focus();
                } else {
                    otherReasonTextarea.style.display = 'none';
                    otherReasonTextarea.value = ''; // Clear content when hidden
                }
            });

            // Function to get URL parameters
            function getQueryParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const pairs = queryString.split("&").filter(Boolean);
                for (const pair of pairs) {
                    const [key, value] = pair.split("=");
                    params[decodeURIComponent(key)] = decodeURIComponent(value || "");
                }
                return params;
            }

            // Populate order details from URL parameters (or fetch from backend)
            const params = getQueryParams();
            const orderId = params.order_id || '#ORD-UNKNOWN'; // Default if not found
            const productName = params.product_name || 'N/A';
            const quantity = params.quantity || '';
            const amount = params.amount ? parseFloat(params.amount).toFixed(2) : '0.00';
            const orderDate = params.order_date || 'N/A';
            const orderStatus = params.status || 'Processing'; // Default status

            document.getElementById('order-id').textContent = orderId;
            document.getElementById('product-name').textContent = `${productName} ${quantity ? `(${quantity})` : ''}`;
            document.getElementById('total-amount').textContent = `$${amount}`;
            document.getElementById('order-date').textContent = orderDate;

            const statusElement = document.getElementById('order-status');
            statusElement.innerHTML = `<span class="status-indicator ${orderStatus.toLowerCase()}">${orderStatus}</span>`;


            // Event listener for the "Confirm Cancellation" button
            initiateCancelButton.addEventListener('click', async () => {
                const selectedReason = reasonSelect.value;
                const otherReasonDetail = otherReasonTextarea.value.trim();

                if (!selectedReason) {
                    showToast('Please select a reason for cancellation.', 'error');
                    return;
                }

                if (selectedReason === 'other' && !otherReasonDetail) {
                    showToast('Please specify your reason for cancellation.', 'error');
                    otherReasonTextarea.focus();
                    return;
                }

                const confirmed = await showConfirmationDialog(
                    "One Last Check!",
                    `You're about to cancel Order ID ${orderId}. This action can't be reversed. Are you truly sure?`
                );

                if (confirmed) {
                    // User confirmed cancellation, proceed with backend call
                    const cancellationData = {
                        order_id: orderId,
                        reason: selectedReason,
                        other_reason_detail: selectedReason === 'other' ? otherReasonDetail : ''
                    };
                    cancelOrder(cancellationData);
                } else {
                    // User cancelled the confirmation
                    showToast('Cancellation paused. Your order is safe!', 'info');
                }
            });
        });

        // Function to send cancellation request to Django backend
        function cancelOrder(data) {
            // In a real Django application, you would send a POST request
            // with the CSRF token and the cancellation data to a Django view.

            // Example (replace with your actual Django URL and method):
            // const csrfToken = getCookie('csrftoken'); // You'll need a getCookie function
            fetch(`/cancel_order_view/${data.order_id}/`, { // Example URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-CSRFToken': csrfToken // Uncomment and provide CSRF token if using POST
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to cancel order.');
                }
            })
            .then(result => {
                showToast(`Order ${data.order_id} has been cancelled!`, 'success');
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = 'order_history.html'; // Or 'cancellation_success.html?order_id=...'
                }, 1500);
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                showToast(`Oops! Couldn't cancel order ${data.order_id}. Please try again.`, 'error');
            });

            // For demonstration purposes, without a backend:
            /*
            showToast(`Initiating cancellation for Order ID: ${data.order_id}...`, 'info');
            console.log('Cancellation Data:', data);
            setTimeout(() => {
                showToast(`Order ${data.order_id} successfully cancelled!`, 'success');
                setTimeout(() => {
                    window.location.href = 'order_history.html'; // Redirect to a hypothetical order history page
                }, 1500);
            }, 1500);
            */
        }

        // Helper function to get CSRF token (if you're using Django POST requests)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>